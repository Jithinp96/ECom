<%-include('../layouts/header.ejs')%>
<%-include('../layouts/navbar.ejs')%>   

<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">My Account</h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->

    <div class="page-content">
        <div class="dashboard">
            <div class="container">
                <div class="row">
                    <aside class="col-md-2 col-lg-2">
                        <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="tab-dashboard-link" data-toggle="tab" href="#tab-dashboard" role="tab" aria-controls="tab-dashboard" aria-selected="true">Dashboard</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-orders-link" data-toggle="tab" href="#tab-orders" role="tab" aria-controls="tab-orders" aria-selected="false">Orders</a>
                            </li>
                            <!-- <li class="nav-item">
                                <a class="nav-link" id="tab-downloads-link" data-toggle="tab" href="#tab-downloads" role="tab" aria-controls="tab-downloads" aria-selected="false">Downloads</a>
                            </li> -->
                            <li class="nav-item">
                                <a class="nav-link" id="tab-address-link" data-toggle="tab" href="#tab-address" role="tab" aria-controls="tab-address" aria-selected="false">Adresses</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-wallet-link" data-toggle="tab" href="#tab-wallet" role="tab" aria-controls="tab-wallet" aria-selected="false">Wallet</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="#">Sign Out</a>
                            </li>
                        </ul>
                    </aside><!-- End .col-lg-3 -->

                    <div class="col-md-8 col-lg-10">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard-link">
                                <table class="table table-bordered table-hover table-striped table-sm">
                                  <thead>
                                    <tr>
                                      <th class="text-center" scope="col">Name</th>
                                      <th class="text-center" scope="col">Email</th>
                                      <th class="text-center" scope="col">Mobile</th>
                                     
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <tr>
                                      <td class="text-center"><%= user.fname %> <%= user.lname %></td>
                                      <td class="text-center"><%= user.email %></td>
                                      <td class="text-center"><%= user.mobile %></td>
                        
                                    </tr>
                                    </tbody>
                                </table>
                                <div class="text-center">
                                    <a href="/edit/<%= user._id %>" class="btn btn-secondary mt-1" data-toggle="modal" data-target="#edituser-modal">Edit Profile</a>

                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-orders" role="tabpanel" aria-labelledby="tab-orders-link">
                                <div class="row mt-4">
                                    <% if (order && order.length > 0) { %>
                                        <!-- <a href="/od/<%= order.orderid %>"> Link to the product details page -->
                                            <% order.forEach(orderItem => { %>
                                                <div class="col-12">
                                                    <div class="card card-dashboard mb-3" onclick="toggleOrderDetails('<%= orderItem._id %>')">
                                                        <div class="card-body">
                                                            <div class="row">
                                                                <% orderItem.products.forEach(product => { %>
                                                                    <div class="col-md-4">
                                                                        <img src="<%= product.image %>" alt="Product Image" class="img-fluid mb-3" style="max-width: 100px;">
                                                                    </div>
                                                                    <div class="col-md-8">
                                                                        <div class="product-info">
                                                                            <p><%= product.name %></p>
                                                                            <p>Quantity: <%= orderItem.products[0].quantity %> Price: â‚¹<%= product.price %></p>
                                                                        </div>
                                                                        <!-- Additional product details can be added here -->
                                                                    </div>
                                                                <% }) %>
                                                            </div><!-- End .row -->
                                                            <a class="btn btn-primary" href="/orderdetails/<%= orderItem._id%>">View Details</a>
                                                        </div><!-- End .card-body -->
                                                        
                                                    </div><!-- End .card-dashboard -->
                                                </div><!-- End .col-12 -->
                                            <% }) %>
                                        <!-- </a> -->
                                        
                                    <% } else { %>
                                        <div class="col-12">
                                            <p>No orders have been made yet.</p>
                                        </div>
                                    <% } %>
                                </div><!-- End .row -->
                                <a href="/home" class="btn btn-outline-primary-2"><span>GO SHOP</span><i class="icon-long-arrow-right"></i></a>
                            </div><!-- .End .tab-pane -->

                            <div class="tab-pane fade" id="tab-address" role="tabpanel" aria-labelledby="tab-address-link">
                                <p>The following addresses will be used on the checkout page by default.</p>
                                
                                <button type="button" class="btn btn-success custom-small-button" data-toggle="modal" data-target="#newaddress-modal">
                                    Add New Address
                                </button><br>

                                <div class="row">
                                    <% if(userAddress && userAddress.length > 0) { %>
                                        <% userAddress.forEach((address, index) => { %>
                                            <div class="col-lg-6">
                                                <div class="card card-dashboard">
                                                    <div class="card-body">
                                                        <!-- Address details -->
                                                        <h4>Name: <%= address.name %></h4>
                                                        <p>
                                                            Address: <%= address.housename %>, 
                                                            <%= address.street %>, 
                                                            <br>City: <%= address.city %>
                                                            <br>Pin: <%= address.pin %>
                                                            <br>Mobile: <%= address.mobile %>
                                                        </p>
                                
                                                        <!-- Delete button with confirmation -->
                                                        <button class="btn btn-danger" onclick="confirmDeleteAddress('<%= address._id %>')">Delete</button>
                                                        <button class="btn btn-primary" onclick="editAddress('<%= address._id %>')">Edit</button>
                                                    </div><!-- End .card-body -->
                                                </div><!-- End .card-dashboard -->
                                            </div><!-- End .col-lg-6 -->
                                        <% }) %>
                                    <% } else { %>
                                        <p>No Address has been added yet.</p>
                                    <% } %>
                                </div><!-- End .row -->
                            </div><!-- .End .tab-pane -->

                            <div class="tab-pane fade" id="tab-wallet" role="tabpanel" aria-labelledby="tab-wallet-link">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h4>Wallet Balance</h4>
                                        <p>Wallet Balance: <%= wallet ? wallet.balance : 'N/A' %></p>
                                    </div><!-- End .col-md-6 -->
                                </div><!-- End .row -->
                            
                                <h4>Transaction History</h4>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Amount</th>
                                                <th>Order</th>
                                                <th>Reason</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (wallet && wallet.walletHistory) { %>
                                                <% wallet.walletHistory.forEach(transaction => { %>
                                                    <tr>
                                                        <td><%= transaction.date.toDateString() %></td>
                                                        <td><%= transaction.type %></td>
                                                        <td>â‚¹<%= transaction.amount.toFixed(2) %></td>
                                                        <td><%= transaction.orderId2 ? '#' + transaction.orderId2 : 'N/A' %></td>
                                                        <td><%= transaction.reason %></td>
                                                    </tr>
                                                <% }) %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="5">No transactions found</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                </div><!-- End .table-responsive -->
                            </div><!-- .End .tab-pane -->
                            
                        </div>
                    </div><!-- End .col-lg-9 -->
                </div><!-- End .row -->
            </div><!-- End .container -->
        </div><!-- End .dashboard -->
    </div><!-- End .page-content -->
</main><!-- End .main -->

<!-- ADD NEW ADDRESS MODAL -->
<div class="modal fade" id="newaddress-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add New Address</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="container-fluid form-group">
                        <label for="inputName">Name</label>
                        <input type="text" class="form-control" id="addressName" placeholder="Enter your name">
                        <div id="validationMessagesName" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">House Name</label>
                        <input type="text" class="form-control" id="houseName" placeholder="Enter your house name">
                        <div id="validationMessagesHouse" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">Street</label>
                        <input type="text" class="form-control" id="street" placeholder="Enter your street name">
                        <div id="validationMessagesStreet" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">City</label>
                        <input type="text" class="form-control" id="city" placeholder="Enter your city name">
                        <div id="validationMessagesCity" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">Pincode</label>
                        <input type="text" class="form-control" id="pincode" placeholder="Enter your pincode">
                        <div id="validationMessagesPincode" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">Mobile</label>
                        <input type="text" class="form-control" id="mobile" placeholder="Enter your mobile number">
                        <div id="validationMessagesMobile" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" id="saveAddressBtn" class="btn btn-primary">Save Address</button>
                    </div>
                </form>
            </div>
            
        </div>
    </div>
</div>

<!-- EDIT ADDRESS MODAL -->
<div class="modal fade" id="editaddress-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Edit Address</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editAddressForm">
                    <input type="hidden" id="editAddressId">
                    <div class="container-fluid form-group">
                        <label for="inputName">Name</label>
                        <input type="text" class="form-control" id="editAddressName" placeholder="Enter your name">
                        <div id="editValidationMessagesName" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">House Name</label>
                        <input type="text" class="form-control" id="editHouseName" placeholder="Enter your house name">
                        <div id="editValidationMessagesHouse" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">Street</label>
                        <input type="text" class="form-control" id="editStreet" placeholder="Enter your street name">
                        <div id="editValidationMessagesStreet" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">City</label>
                        <input type="text" class="form-control" id="editCity" placeholder="Enter your city name">
                        <div id="editValidationMessagesCity" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">Pincode</label>
                        <input type="text" class="form-control" id="editPincode" placeholder="Enter your pincode">
                        <div id="editValidationMessagesPincode" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="container-fluid form-group">
                        <label for="inputName">Mobile</label>
                        <input type="text" class="form-control" id="editMobile" placeholder="Enter your mobile number">
                        <div id="editValidationMessagesMobile" class="text-danger" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" id="updateAddressBtn" class="btn btn-primary">Update Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>




<!-- Add your script -->

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script>
    // JavaScript function to populate the edit address modal and handle form submission
    function editAddress(addressId) {
        // Fetch the address details using AJAX
        $.ajax({
            url: `/user/address/${addressId}`, // Endpoint to fetch address details by ID
            method: 'GET',
            success: function(response) {
                // Populate the edit address modal fields with the fetched data
                $('#editAddressName').val(response.name);
                $('#editHouseName').val(response.housename);
                $('#editStreet').val(response.street);
                $('#editCity').val(response.city);
                $('#editPincode').val(response.pin);
                $('#editMobile').val(response.mobile);

                // Set the address ID in a hidden field for submission
                $('#editAddressId').val(addressId);

                // Show the edit address modal
                $('#editaddress-modal').modal('show');
            },
            error: function(error) {
                console.error('Error fetching address details:', error);
            }
        });
    }

    // JavaScript function to handle form submission for updating address
    $('#updateAddressBtn').click(function() {
        // Retrieve updated address details from the modal fields
        var addressId = $('#editAddressId').val();
        var updatedName = $('#editAddressName').val().trim();
        var updatedHouseName = $('#editHouseName').val().trim();
        var updatedStreet = $('#editStreet').val().trim();
        var updatedCity = $('#editCity').val().trim();
        var updatedPincode = $('#editPincode').val().trim();
        var updatedMobile = $('#editMobile').val().trim();

        // Define a flag to track validation status
         var isValid = true;

        // Validate the input fields
        if (!updatedName) {
            $('#editValidationMessagesName').html('Please enter your name.').show();
            isValid = false;
        } else {
            $('#editValidationMessagesName').hide();
        }

        if (!updatedHouseName) {
            $('#editValidationMessagesHouse').html('Please enter your house name.').show();
            isValid = false;
        } else {
            $('#editValidationMessagesHouse').hide();
        }

        if (!updatedStreet) {
            $('#editValidationMessagesStreet').html('Please enter your street name.').show();
            isValid = false;
        } else {
            $('#editValidationMessagesStreet').hide();
        }

        if (!updatedCity) {
            $('#editValidationMessagesCity').html('Please enter your city name.').show();
            isValid = false;
        } else {
            $('#editValidationMessagesCity').hide();
        }

        if (!updatedPincode) {
            $('#editValidationMessagesPincode').html('Please enter your pincode.').show();
            isValid = false;
        } else if (!/^\d{6}$/.test(updatedPincode)) {
            $('#editValidationMessagesPincode').html('Pincode should be exactly 6 digits.').show();
            isValid = false;
        } else {
            $('#editValidationMessagesPincode').hide();
        }

        if (!updatedMobile) {
            $('#editValidationMessagesMobile').html('Please enter your mobile number.').show();
            isValid = false;
        } else if (!/^\d{10}$/.test(updatedMobile)) {
            $('#editValidationMessagesMobile').html('Mobile number should be exactly 10 digits.').show();
            isValid = false;
        } else {
            $('#editValidationMessagesMobile').hide();
        }

        // If any field is invalid, prevent form submission
        if (!isValid) {
            return;
        }



        // Create an object with the updated address details
        var updatedAddress = {
            name: updatedName,
            housename: updatedHouseName,
            street: updatedStreet,
            city: updatedCity,
            pin: updatedPincode,
            mobile: updatedMobile
        };

        // Send the updated address details to the server using AJAX for updating
        $.ajax({
            url: `/user/address/${addressId}`, // Endpoint to update address details by ID
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(updatedAddress),
            success: function(response) {
                // Handle the success response
                console.log('Address updated successfully:', response);

                // Reload the page or update the UI as needed
                location.reload();
            },
            error: function(error) {
                // Handle the error response
                console.error('Error updating address:', error);
            }
        });

        // Close the edit modal after submitting the form
        $('#editaddress-modal').modal('hide');
    });
</script>

<script>
    $(document).ready(function () {
        // Add event listener to clear error message on input focus
        $('#addressName, #houseName, #street, #city, #pincode, #mobile').on('input', function () {
            var fieldId = '#validationMessages' + $(this).attr('id').charAt(0).toUpperCase() + $(this).attr('id').slice(1);
            $(fieldId).hide().empty();
        });

        // Event listener for address selection
        $('input[name="addressSelection"]').on('change', function () {
            $('#selectedAddress').val($(this).attr('data-address-id'));
        });

        $('#saveAddressBtn').click(function () {
            // Clear previous error messages
            $('.text-danger').empty().hide();

            // Validate each input field
            var addressName = $('#addressName').val().trim();
            var houseName = $('#houseName').val().trim();
            var street = $('#street').val().trim();
            var city = $('#city').val().trim();
            var pincode = $('#pincode').val().trim();
            var mobile = $('#mobile').val().trim();

            var isValid = true;

            if (addressName === '') {
                appendErrorMessage('#validationMessagesName', 'Please enter your name.');
                isValid = false;
            }

            if (houseName === '') {
                appendErrorMessage('#validationMessagesHouse', 'Please enter your house name.');
                isValid = false;
            }

            if (street === '') {
                appendErrorMessage('#validationMessagesStreet', 'Please enter your street name.');
                isValid = false;
            }

            if (city === '') {
                appendErrorMessage('#validationMessagesCity', 'Please enter your city name.');
                isValid = false;
            }

            // Validate pincode with exactly 6 digits
            if (!/^\d{6}$/.test(pincode)) {
                appendErrorMessage('#validationMessagesPincode', 'Please enter a valid 6-digit pincode.');
                isValid = false;
            }

            // Validate mobile with exactly 10 digits
            if (!/^\d{10}$/.test(mobile)) {
                appendErrorMessage('#validationMessagesMobile', 'Please enter a valid 10-digit mobile number.');
                isValid = false;
            }

            // If all validation passes, you can proceed to save the address
            if (isValid) {
                // Create an object with the address details
                var newAddress = {
                    name: addressName,
                    housename: houseName,
                    street: street,
                    city: city,
                    pin: parseInt(pincode),
                    mobile: parseInt(mobile)
                };

                // Now, you can save the address details to MongoDB
                saveAddressToDatabase(newAddress);

                // Close the modal
                $('#newaddress-modal').modal('hide');
            }
        });

        function appendErrorMessage(fieldId, message) {
            $(fieldId).html(message).show();
        }

        function saveAddressToDatabase(newAddress) {
            // Perform an AJAX request or use a backend route to save the address to MongoDB
            // Example using jQuery AJAX (replace with your actual backend route)
            $.ajax({
                type: 'POST',
                url: '/saveNewAddress', // Replace with your backend route
                contentType: 'application/json',
                data: JSON.stringify(newAddress),
                success: function (response) {
                    // Handle the success response
                    console.log('Address saved successfully:', response);

                    // Reload the page after successful save
                    location.reload();
                },
                error: function (error) {
                    // Handle the error response
                    console.error('Error saving address:', error);
                }
            });
        }
    });
</script>



<script>
    function toggleOrderDetails(orderId) {
        const orderDetails = document.getElementById(`orderDetails${orderId}`);
        orderDetails.style.display = orderDetails.style.display === 'none' ? 'block' : 'none';
    }
</script>

<script>
    function confirmDeleteAddress(addressId) {
        const confirmation = confirm("Are you sure you want to delete this address?");
        if (confirmation) {
            // Perform AJAX request or navigate to a delete route
            // Example: Use fetch or jQuery.ajax to send a DELETE request to your server
            fetch(`/delete-address/${addressId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                // Handle success or error response from the server
                if (data.success) {
                    // Address deleted successfully, you can update the UI or reload the page
                    location.reload();
                } else {
                    alert('Failed to delete address. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error deleting address:', error);
            });
        }
    }
</script>



