<%-include('../layouts/header.ejs')%>
<%-include('../layouts/navbar.ejs')%>

<main class="main">
    <div class="login-page bg-image pt-8 pb-8 pt-md-12 pb-md-12 pt-lg-17 pb-lg-17" style="background-image: url('assets/images/backgrounds/login-bg.jpg')">
        <div class="container">
            <div class="form-box">
                <div class="form-tab">
                    <ul class="nav nav-pills nav-fill" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="register-tab-2" data-toggle="tab" href="#register-2" role="tab" aria-controls="register-2" aria-selected="true">
                                Reset Password
                            </a>
                        </li>
                    </ul>
                    <br>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="signin-2" role="tabpanel" aria-labelledby="signin-tab-2">
                
                            <form id="reset-password-form" action="/resetpassword" method="POST">
                                <div class="form-group">
                                    <label for="new-password">New Password *</label>
                                    <input type="password" class="form-control" id="new-password" name="newPassword" placeholder="Enter New Password">
                                    <span id="password-error" class="error-message"></span> 
                                </div><!-- End .form-group -->
                            
                                <div class="form-group">
                                    <label for="confirm-new-password">Confirm New Password *</label>
                                    <input type="password" class="form-control" id="confirm-new-password" name="confirmNewPassword" placeholder="Confirm New Password">
                                    <span id="confirm-password-error" class="error-message"></span> 
                                </div><!-- End .form-group -->
                                                        
                                <br>
                                <div class="form-footer">
                                    <button id="save-password-button" type="button" class="btn btn-outline-primary-2">
                                        <span>Save Password</span>
                                        <i class="icon-long-arrow-right"></i>
                                    </button>
                                </div><!-- End .form-footer -->
                            </form>
                            <p>Want to login?<a href="/login" class="forgot-link">Login</a></p>
                        </div><!-- .End .tab-pane -->
                        </div><!-- .End .tab-pane -->
                    </div><!-- End .tab-content -->
                </div><!-- End .form-tab -->
            </div><!-- End .form-box -->
        </div><!-- End .container -->
    </div><!-- End .login-page section-bg -->
</main><!-- End .main -->



<script>
    document.addEventListener('DOMContentLoaded', function () {
        const savePasswordButton = document.getElementById('save-password-button');

        savePasswordButton.addEventListener('click', async function () {
            // Extracting email from the URL query string
            const queryParams = new URLSearchParams(window.location.search);
            const email = queryParams.get('email');

            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;

            if (newPassword !== confirmNewPassword) {
                // Display error message or handle passwords mismatch
                return;
            }

            // Update password
            await updatePassword(email, newPassword);
        });
    });

    const updatePassword = async (email, newPassword) => {
    try {
        const response = await fetch('/update-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, newPassword })
        });

        if (response.ok) {
            console.log('Password updated successfully');
            // Redirect the user to a success page or do something else
        } else {
            console.error('Failed to update password:', await response.text());
            // Handle error response from the server
        }
    } catch (error) {
        console.error('Error updating password:', error);
        // Handle network or other errors
    }
};

document.addEventListener('DOMContentLoaded', function () {
    const verifyOTPButton = document.getElementById('verify-otp-button');
    const otpInputContainer = document.getElementById('otp-input-container');
    const otpError = document.getElementById('otp-error');

    verifyOTPButton.addEventListener('click', async function () {
        // Retrieve the OTP entered by the user
        const otpDigits = Array.from(document.querySelectorAll('.input-field input')).map(input => input.value).join('');
        const email = document.getElementById('singin-email-2').value;

        try {
            const response = await fetch('/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, otp: otpDigits })
            });

            if (response.ok) {
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;

                if (newPassword !== confirmNewPassword) {
                    // Display error message or handle passwords mismatch
                    return;
                }

                // Update password
                await updatePassword(email, newPassword);

                // Redirect to success page or perform other actions
            } else {
                otpError.innerText = 'Invalid OTP. Please try again.';
            }
        } catch (error) {
            console.error('Error verifying OTP:', error);
            otpError.innerText = 'Failed to verify OTP. Please try again later.';
        }
    });
});
</script>

<%-include('../layouts/footbar.ejs')%>
<%-include('../layouts/footer.ejs')%>