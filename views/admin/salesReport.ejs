<%-include('../layouts/adminHeader.ejs')%>
<%-include('../layouts/adminSidebar.ejs')%>

<!-- This page plugin CSS -->
<link href="/admin/assets/extra-libs/datatables.net-bs4/css/dataTables.bootstrap4.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">

<style>
    /* Custom CSS to adjust the size of date picker input fields */
    #startDatePicker,
    #endDatePicker {
        width: 150px; /* Adjust the width as needed */
    }
</style>


<div class="page-wrapper">
    <div class="container-fluid">
        
        
        <!-- sales table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    
                    <div class="card-body">
                        <h4 class="card-title">Sales Report</h4>
                        <!-- Date range filter -->
                        <div class="container p-2">
                            <label for="">Start date</label>
                            <input type="date" id="startDate" >
                       
                            <label for="" class="ms-5">End date</label>
                            <input type="date" id="endDate" >
            
                            <a href="#" class="btn btn-primary ms-5" onclick="generate()">Generate</a>
                        </div>
                        <div class="table-responsive">
                            <table id="zero_config" class="table table-striped table-bordered no-wrap">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Order ID</th>
                                        <th>Order Date</th>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Subtotal</th>
                                        <th>Status</th>
                                        
                                    </tr>
                                </thead>
                                <tbody>
                                    <% orders.forEach(order => { %>
                                        <% order.products.forEach(product => { %>
                                            <tr>
                                                <td><%= order.userId.fname %> <%= order.userId.lname %></td>
                                                <td><%= order.orderId %></td>
                                                <td><%= order.date.toDateString() %></td>
                                                <td><%= product.name %></td>
                                                <td><%= product.price %></td>
                                                <td><%= product.quantity %></td>
                                                <td><%= product.total %></td>
                                                <td><%= product.orderStatus %></td>
                                                
                                            </tr>
                                        <% }) %>
                                    <% }) %>
                                    
                                </tbody>
                            
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Initialize Bootstrap Datepicker -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function generate() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please select both start and end dates!',
        });
        return;
    }

    const data = {
        startDate: startDate,
        endDate: endDate
    };

    fetch('/admin/salesreport', {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.orders && result.orders.length > 0) {
            const tableBody = document.querySelector('#zero_config tbody');
            tableBody.innerHTML = '';
            let totalOrderPrice = 0;
            result.orders.forEach(order => {
                order.products.forEach(product => {
                    totalOrderPrice += product.total;

                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = order.userId.fname + ' ' + order.userId.lname;
                    row.insertCell(1).textContent = order.orderId;
                    row.insertCell(2).textContent = new Date(order.date).toDateString();
                    row.insertCell(3).textContent = product.name;
                    row.insertCell(4).textContent = product.price;
                    row.insertCell(5).textContent = product.quantity;
                    row.insertCell(6).textContent = product.total;
                    row.insertCell(7).textContent = product.orderStatus;
                });
            });
            document.getElementById('total').innerHTML = `Total: ${totalOrderPrice}`;
        } else {
            Swal.fire({
                icon: 'info',
                title: 'No Data',
                text: 'No data available for the selected date range.',
            });
        }
    })
    .catch(error => {
        console.error("Error fetching data:", error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Failed to fetch data. Please try again.',
        });
    });
}

</script>

<!--This page plugins -->
<script src="/admin/assets/extra-libs/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="/admin/dist/js/pages/datatable/datatable-basic.init.js"></script>

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>


<%-include('../layouts/adminFooter.ejs')%>